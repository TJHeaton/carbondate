<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Determining Convergence • carbondate</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Determining Convergence">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">carbondate</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.0.1.9000</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../articles/carbondate.html">Get started</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/Independent_calibration.html">Independent and Joint Radiocarbon Calibration</a></li>
    <li><a class="dropdown-item" href="../articles/Against_SPDs.html">Why Not to Use SPDs</a></li>
    <li><a class="dropdown-item" href="../articles/Non-parametric-summed-density.html">Non-Parametric Joint Density Estimation</a></li>
    <li><a class="dropdown-item" href="../articles/Poisson-process-modelling.html">Poisson Process Modelling</a></li>
    <li><a class="dropdown-item" href="../articles/determining-convergence.html">Determining Convergence</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/TJHeaton/carbondate/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Determining Convergence</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/TJHeaton/carbondate/blob/main/vignettes/determining-convergence.Rmd" class="external-link"><code>vignettes/determining-convergence.Rmd</code></a></small>
      <div class="d-none name"><code>determining-convergence.Rmd</code></div>
    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/TJHeaton/carbondate" class="external-link">carbondate</a></span><span class="op">)</span></span></code></pre></div>
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>A few tools to determine how well the MCMC for the various approaches
have converged.</p>
<div class="section level3">
<h3 id="examining-the-gelman-rubin-convergence-diagnostic">Examining the Gelman-Rubin convergence diagnostic<a class="anchor" aria-label="anchor" href="#examining-the-gelman-rubin-convergence-diagnostic"></a>
</h3>
<p>This is often used to evaluate MCMC convergence. It compares the
<em>between-chains</em> variance with the <em>within-chains</em>
variance of the model parameters for multiple MCMC chains. If the MCMC
has converged to the target posterior, then these values should be
similar. To assess convergence of our methods, we apply it to the
individual posterior calendar age estimates of the <sup>14</sup>C
samples. We have
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>N</mi><annotation encoding="application/x-tex">N</annotation></semantics></math>
such samples, each of which has a individual sequence of sampled
calendar age values that are stored within the overall MCMC. We
calculate the potential scale reduction factor (PSRF) for each
individual sample’s calendar age sequence, generating
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>N</mi><annotation encoding="application/x-tex">N</annotation></semantics></math>
PSRF values. If the MCMC has converged to the target posterior
distribution, then each of these PSRFs should be close to 1.</p>
<p>In the first case, the relevant MCMC function can be run multiple
times. This generate different chains.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">all_outputs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fl">3</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="va">i</span> <span class="op">+</span> <span class="fl">1</span><span class="op">)</span></span>
<span>  <span class="va">all_outputs</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/PolyaUrnBivarDirichlet.html">PolyaUrnBivarDirichlet</a></span><span class="op">(</span></span>
<span>      <span class="va">kerr</span><span class="op">$</span><span class="va">c14_age</span>, <span class="va">kerr</span><span class="op">$</span><span class="va">c14_sig</span>, <span class="va">intcal20</span>, n_iter <span class="op">=</span> <span class="fl">1e4</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="fu"><a href="../reference/PlotGelmanRubinDiagnosticMultiChain.html">PlotGelmanRubinDiagnosticMultiChain</a></span><span class="op">(</span><span class="va">all_outputs</span><span class="op">)</span></span></code></pre></div>
<p><img src="figures-convergence%2Fcalculate_gr_multiple-1.png" width="100%"></p>
<p>It can also be calculated by taking a single MCMC run, and splitting
it into multiple parts to compare the <em>within-segment</em> variance
with the <em>between-segment</em> variance for each calendar age
observation.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">3</span><span class="op">)</span></span>
<span><span class="va">output</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/PolyaUrnBivarDirichlet.html">PolyaUrnBivarDirichlet</a></span><span class="op">(</span></span>
<span>    <span class="va">kerr</span><span class="op">$</span><span class="va">c14_age</span>, <span class="va">kerr</span><span class="op">$</span><span class="va">c14_sig</span>, <span class="va">intcal20</span>, n_iter <span class="op">=</span> <span class="fl">2e4</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="../reference/PlotGelmanRubinDiagnosticSingleChain.html">PlotGelmanRubinDiagnosticSingleChain</a></span><span class="op">(</span><span class="va">output</span>, n_burn <span class="op">=</span> <span class="fl">5e3</span><span class="op">)</span></span></code></pre></div>
<p><img src="figures-convergence%2Fcalculate_gr-1.png" width="100%"></p>
<p>As you can see, even with a few iterations (where we would expect the
result not to have converged yet) the PSRF values are close to one.</p>
</div>
<div class="section level3">
<h3 id="examining-the-predictive-distribution-or-posterior-occurrence-rate">Examining the predictive distribution or posterior occurrence
rate<a class="anchor" aria-label="anchor" href="#examining-the-predictive-distribution-or-posterior-occurrence-rate"></a>
</h3>
<p>When calibrating multiple <sup>14</sup>C determinations, primary
interest will frequently be in the summarised (predictive) calendar age
estimate if using the Bayesian non-parametric method, or the posterior
occurrence rate if using the Poisson process approach, rather than the
age of any individual sample. Information on the predictive estimate is
encapsulated in the model parameters relating to the underlying clusters
(e.g., weights and distributions). While the occurrence rate is defined
by the locations of the changepoints, and the segment heights, in the
Poisson process model.</p>
<p>Unfortunately, the chains storing these parameters are not suitable
for the Gelman-Rubin diagnostic. In the case of the predictive Bayesian
non-parametric estimate, the number and identity of the clusters stored
in the MCMC can change with each iteration (as clusters drop-in and out,
or are relabelled). In the case of the Poisson process occurrence rate,
the number and labelling of changepoints varies throughout the MCMC. We
therefore provide a further diagnostic, based upon assessing the
predictive calendar age estimate or posterior occurrence rate, which may
be a much more useful indicator of MCMC convergence.</p>
<div class="section level4">
<h4 id="visually-comparing-multiple-runs">Visually comparing multiple runs<a class="anchor" aria-label="anchor" href="#visually-comparing-multiple-runs"></a>
</h4>
<p>Running the functions a few time with different random number seeds
can give an idea of how many iterations are needed for convergence. If
the MCMC has converged, then each run should lead to a similar result
for the predictive density (or the posterior occurrence rate in the case
of the POisson process model). For example,</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">outputs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fl">3</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="va">i</span><span class="op">+</span><span class="fl">1</span><span class="op">)</span></span>
<span>  <span class="va">outputs</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/PolyaUrnBivarDirichlet.html">PolyaUrnBivarDirichlet</a></span><span class="op">(</span></span>
<span>      rc_determinations <span class="op">=</span> <span class="va">kerr</span><span class="op">$</span><span class="va">c14_age</span>,</span>
<span>      rc_sigmas <span class="op">=</span> <span class="va">kerr</span><span class="op">$</span><span class="va">c14_sig</span>,</span>
<span>      calibration_curve<span class="op">=</span><span class="va">intcal20</span>,</span>
<span>      n_iter <span class="op">=</span> <span class="fl">1e4</span><span class="op">)</span></span>
<span>  <span class="va">outputs</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">label</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">"Seed ="</span>, <span class="va">i</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="fu"><a href="../reference/PlotPredictiveCalendarAgeDensity.html">PlotPredictiveCalendarAgeDensity</a></span><span class="op">(</span></span>
<span>  <span class="va">outputs</span>, n_posterior_samples <span class="op">=</span> <span class="fl">500</span>, denscale <span class="op">=</span> <span class="fl">2</span>, interval_width <span class="op">=</span> <span class="st">"1sigma"</span><span class="op">)</span></span></code></pre></div>
<p><img src="figures-convergence%2Fcalculate_polya_kerr-1.png" width="100%"></p>
<p>As you can see, in this case (255 determinations collated by Kerr and
McCormick <span class="citation">(Kerr and McCormick 2014)</span>) the
different runs do not have similar outputs, so more iterations would be
needed to ensure convergence.</p>
<p>In contrast, if we run a much simpler example (that of artificial
data comprised of two normals), we can see that convergence appears to
be achieved in a small number of iterations.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">outputs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fl">3</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="va">i</span> <span class="op">+</span> <span class="fl">1</span><span class="op">)</span></span>
<span>  <span class="va">outputs</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/PolyaUrnBivarDirichlet.html">PolyaUrnBivarDirichlet</a></span><span class="op">(</span></span>
<span>  rc_determinations <span class="op">=</span> <span class="va">two_normals</span><span class="op">$</span><span class="va">c14_age</span>,</span>
<span>  rc_sigmas <span class="op">=</span> <span class="va">two_normals</span><span class="op">$</span><span class="va">c14_sig</span>,</span>
<span>  calibration_curve<span class="op">=</span><span class="va">intcal20</span>,</span>
<span>  n_iter <span class="op">=</span> <span class="fl">1e4</span><span class="op">)</span></span>
<span>  <span class="va">outputs</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">label</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">"Seed ="</span>, <span class="va">i</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="fu"><a href="../reference/PlotPredictiveCalendarAgeDensity.html">PlotPredictiveCalendarAgeDensity</a></span><span class="op">(</span></span>
<span>  <span class="va">outputs</span>, n_posterior_samples <span class="op">=</span> <span class="fl">500</span>, denscale <span class="op">=</span> <span class="fl">2</span>, interval_width <span class="op">=</span> <span class="st">"1sigma"</span><span class="op">)</span></span></code></pre></div>
<p><img src="figures-convergence%2Fcalculate_polya_normals-1.png" width="100%"></p>
<p>This approach to assessing convergence can be taken with either the
Bayesian non-parametric method, or the Poisson process modelling.</p>
</div>
<div class="section level4">
<h4 id="examining-the-kullbackleibler-divergence-bayesian-non-parametrics-only">Examining the Kullback–Leibler divergence (Bayesian non-parametrics
only)<a class="anchor" aria-label="anchor" href="#examining-the-kullbackleibler-divergence-bayesian-non-parametrics-only"></a>
</h4>
<p>We also provide a further diagnostic specifically for the Bayesian
non-parametric approach (it is not applicable for the Poisson process
model). This diagnostic gives a measure of the difference between an
initial (baseline) predictive density and the predictive density as the
MCMC progresses.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">50</span><span class="op">)</span></span>
<span><span class="va">output</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/WalkerBivarDirichlet.html">WalkerBivarDirichlet</a></span><span class="op">(</span></span>
<span>    rc_determinations <span class="op">=</span> <span class="va">kerr</span><span class="op">$</span><span class="va">c14_age</span>,</span>
<span>    rc_sigmas <span class="op">=</span> <span class="va">kerr</span><span class="op">$</span><span class="va">c14_sig</span>,</span>
<span>    calibration_curve<span class="op">=</span><span class="va">intcal20</span>,</span>
<span>    n_iter <span class="op">=</span> <span class="fl">1e5</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="../reference/PlotConvergenceData.html">PlotConvergenceData</a></span><span class="op">(</span><span class="va">output</span><span class="op">)</span></span></code></pre></div>
<p><img src="figures-convergence%2Fcalculate_kld-1.png" width="100%"></p>
<p>It can give an idea of convergence as well as which iteration number
to use for <code>n_burn</code> when calculating the predictive density
(by default set to half the chain).</p>
</div>
</div>
</div>
<div class="section level2">
<h2 class="unnumbered" id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h2>
<div id="refs" class="references csl-bib-body hanging-indent" entry-spacing="0">
<div id="ref-kerr2014" class="csl-entry">
Kerr, T. R., and F. McCormick. 2014. <span>“Statistics, Sunspots and
Settlement: Influences on Sum of Probability Curves.”</span> <em>Journal
of Archaeological Science</em> 41 (January): 493–501. <a href="https://doi.org/10.1016/j.jas.2013.09.002" class="external-link">https://doi.org/10.1016/j.jas.2013.09.002</a>.
</div>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Timothy J Heaton, Sara Al-assam.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer>
</div>





  </body>
</html>
