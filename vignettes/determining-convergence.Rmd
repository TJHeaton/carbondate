---
title: "determining-convergence"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{determining-convergence}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(carbondate)
```

# Introduction

A few tools to determine how well the result has converged.

## Compare multiple runs

Running a few time with different random number seeds can give an idea of how many iterations are
needed for convergence. If the result is converged each run should lead to a similar result. E.g.

```{r calculate_walker, fig.width=10, fig.height=8, results=FALSE}
all_outputs = list()
for (i in 1:3) {
  set.seed(i)
  all_outputs[[i]] <- WalkerBivarDirichlet(
  rc_determinations = kerr$c14_age,
  rc_sigmas = kerr$c14_sig,
  calibration_curve=intcal20,
  n_iter = 1e4)
  all_outputs[[i]]$label = paste("Seed =", i)
}
PlotPredictiveCalendarAgeDensity(
  output_data = all_outputs, n_posterior_samples = 500, denscale = 2.5, interval_width = "1sigma")
```

As you can see the different runs do not have similar outputs, so more iterations would be needed
to ensure convergence.

## Examining the Kullback–Leibler divergence

This gives a measure of the difference between the initial predicitive density and the predictive
density as the simulation progresses.

```{r calculate_kld, fig.width=10, fig.height=8, results=FALSE}
set.seed(1)
output <- PolyaUrnBivarDirichlet(
rc_determinations = kerr$c14_age,
rc_sigmas = kerr$c14_sig,
calibration_curve=intcal20,
n_iter = 1e5)

PlotConvergenceData(output)
```

It can give an idea of convergence as well as which iteration number to use for `n_burn` when
calculating the predictive density (by default set to half the chain)

## Examining the Gelman–Rubin convergence diagnostic

This takes a single chain, splits it into 3 and compares the within-chain variance with the between chains variance for each calendar age observation. If the chain have converged to the target posterior distribution, then PSRF should be close to 1 for every calendar age observation.

```{r calculate_gr, fig.width=10, fig.height=8, results=FALSE}
set.seed(1)
output <- PolyaUrnBivarDirichlet(
rc_determinations = kerr$c14_age,
rc_sigmas = kerr$c14_sig,
calibration_curve=intcal20,
n_iter = 1e5)

PlotGelmanRubinDiagnostic(output, 5e4)
```
